stages:
    - build
    - install
    - build_test
    - run_test
    - doc
      
before_script:
  - mkdir -p ~/lib/dd_avx
  - export LD_LIBRARY_PATH=~/lib/dd_avx

###################################################

build_lib:
    stage: build
    tags:
        - hishinuma-ci
    script:
        - make
        - ls
        - ls lib/
        - ls include/qd/
    artifacts:
        paths:
            - include/
            - lib/
        expire_in: 1day

###################################################

install_lib:
    stage: install
    tags:
        - hishinuma-ci
    script:
        - make install
    dependencies:
        - "build_lib"
    artifacts:
        paths:
            - ~/lib/dd_avx/
        expire_in: 1day

###################################################

test_build:
    stage: build_test
    tags:
        - hishinuma-ci
    script:
        - cd test; make clean; make
    dependencies:
        - "install_lib"
    artifacts:
        paths:
            - test/
        expire_in: 1day

###################################################

scalar:
    stage: run_test
    tags:
        - hishinuma-ci
    script:
        - cd test; make run_scalar;
    artifacts:
        paths:
            - test_build/
        expire_in: 1day

test_run:
    stage: run_test
    tags:
        - hishinuma-ci
    script:
        - cd test; make run_vector;
    artifacts:
        paths:
            - test_build/
        expire_in: 1day
###################################################

doc:
    stage: doc
    tags:
        - hishinuma-ci
    script:
        - rm -rf /public/dd_avx/
        - cd doc/; doxygen ./Doxyfile; cd -
        - mv doc/html /public/dd_avx
    dependencies:
        - "run_test"
